<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://kit.fontawesome.com/6847ed686e.js" crossorigin="anonymous"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="style.css">
    <title>Account Activation</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .loading {
            display: none;
            width: 80px;
            height: 80px;
            border: 8px solid #eee;
            border-top: 8px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <header>
        <div style="display:flex;margin-left:20px;">
            <div class="container" onclick="openNav(this)">
                <div class="bar1"></div>
                <div class="bar2"></div>
                <div class="bar3"></div>
            </div>
            <p class="animated-text">FREELANCE GRID WRITERS</p>
            <div id="profileCircle" class="profile-circle" style="width:30px;height:30px;border-radius:50%;background:#91af4c;
            display:flex;align-items:center;justify-content:center;font-weight:bold;">
            </div>
        </div>
    </header>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <p style="margin-left:20px;"><i class="fa-solid fa-landmark"></i> NAVIGATION</p>
        <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
        <a href="Manualact.html"><i class="fa-solid fa-chart-line"></i> Account Activation</a>
        <a href="availjobs.html"><i class="fa-solid fa-list-check"></i> Available Jobs</a>
        <a href="virtualtr.html"><i class="fa-solid fa-cloud"></i> Virtual training</a>
        <a href="awardedjobs.html"><i class="fa-solid fa-award"></i> Awarded jobs</a>
        <a href="submitjbs.html"><i class="fa-solid fa-check"></i> Submit jobs</a>
        <a href="cashout.html"><i class="fa-solid fa-wallet"></i> Cashout</a>
        <a href="myprof.html"><i class="fa-solid fa-user"></i> My profile</a>
        <a href="#" onclick="logout()"><i class="fa-solid fa-power-off"></i> Logout</a>
    </div>

    <div id="main">
        <p id="pho" style="margin-left:30px;margin-top:20px;font-weight:bolder;">ACCOUNT ACTIVATION</p>

        <div
            style="background:rgba(255,165,0,.1);padding:20px;border-radius:10px;width:90%;margin:20px auto;text-align:center;">
            <p id="note">
                NOTE: To activate your freelance account, a one-time non-refundable fee of <b>KES 150</b> is required.
            </p>
            <p>This payment helps us verify serious applicants and maintain the quality of opportunities on our
                platform. Once your account is activated, you’ll gain full access to available projects, client tools,
                and freelancer resources.</p>

            <input id="phoneInput" type="tel" placeholder="Enter M-Pesa Phone (07XXXXXXXX)"
                style="width:90%;padding:12px;border-radius:5px;border:1px solid #ccc;margin-top:15px;">

            <button id="activateNowButton" style="background:#28a745;color:white;border:none;padding:12px 25px;
            font-size:16px;border-radius:5px;margin-top:20px;cursor:pointer;">
                Pay with M-Pesa
            </button>
        </div>

        <div id="loading" class="loading"></div>
    </div>

    <footer style="background:black;margin-top:20px;">
        <p style="font-size:x-large;">FREELANCE GRID WRITERS</p>
        <p>&copy; 2025 FREELANCE GRID. All Rights Reserved.</p>
        <p>Designed by Rollo Houd</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getDatabase, ref, update, get } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDSzJimWxr3LlWm7etgNgsngGbBkwJzYrI",
            authDomain: "w3sfreelancewriter.firebaseapp.com",
            databaseURL: "https://w3sfreelancewriter-default-rtdb.firebaseio.com",
            projectId: "w3sfreelancewriter",
            storageBucket: "w3sfreelancewriter.appspot.com",
            messagingSenderId: "743098413859",
            appId: "1:743098413859:web:0556daeff74b515afbd296"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        document.addEventListener("DOMContentLoaded", async () => {
            const loggedInUser = JSON.parse(sessionStorage.getItem("loggedInUser"));

            if (!loggedInUser || !loggedInUser.phone) {
                window.location.href = "signin.html";
                return;
            }

            try {
                const userRef = ref(database, "users/" + loggedInUser.phone);
                const snapshot = await get(userRef);

                if (snapshot.exists() && snapshot.val().status === "ACTIVE") {
                    // ✅ User is active → allow access
                    window.location.href = "virtualtr.html";
                }
                // else: user is not ACTIVE → do nothing or show message
            } catch (error) {
                console.error("Status check failed:", error);
            }
        });

        /* ================= PAYHERO CONFIG ================= */
        const BASIC_AUTH_TOKEN = "Basic TkxXenhHWVhFeDZtUHBYWEFPRHo6alZ0cDFycXBxSk1MUmEwa2ZHclF6alBjTGtTa2pCd3I3WmRBTHRidg==";
        const CHANNEL_ID = 4707;
        const AMOUNT = 150;
        /* ================================================== */

        function normalizePhone(p) {
            let s = p.replace(/\D/g, "");
            if (s.startsWith("0")) return "254" + s.slice(1);
            if (s.startsWith("7")) return "254" + s;
            return s;
        }

        async function sendSTK(amount, phone) {
            const payload = {
                amount,
                phone_number: phone,
                channel_id: CHANNEL_ID,
                provider: "m-pesa",
                external_reference: "FGW-" + Date.now()
            };

            const res = await fetch("https://backend.payhero.co.ke/api/v2/payments", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": BASIC_AUTH_TOKEN
                },
                body: JSON.stringify(payload)
            });

            return res.json();
        }

        async function verify(reference) {
            const res = await fetch(
                `https://backend.payhero.co.ke/api/v2/transaction-status?reference=${reference}`,
                { headers: { "Authorization": BASIC_AUTH_TOKEN } }
            );
            return res.json();
        }

        document.getElementById("activateNowButton").addEventListener("click", async () => {
            const phoneInput = document.getElementById("phoneInput").value.trim();
            const loggedInUser = JSON.parse(sessionStorage.getItem("loggedInUser"));
            if (!loggedInUser) return window.location.href = "signin.html";

            const phone = normalizePhone(phoneInput);
            if (phone.length < 12) {
                Toastify({ text: "Invalid phone number", backgroundColor: "#ff3b30" }).showToast();
                return;
            }

            document.getElementById("loading").style.display = "block";

            try {
                const stk = await sendSTK(AMOUNT, phone);
                const refId = stk.reference || stk.request_id;

                for (let i = 0; i < 10; i++) {
                    await new Promise(r => setTimeout(r, 3000));
                    const status = await verify(refId);

                    if (status.status === "SUCCESS" || status.status === "COMPLETED") {
                        await update(ref(database, "users/" + loggedInUser.phone), { status: "ACTIVE" });
                        Swal.fire("Success", "Account activated successfully", "success");
                        window.location.href = "dashboard.html";
                        return;
                    }

                    if (status.status === "FAILED") {
                        throw new Error("Payment failed");
                    }
                }

                Swal.fire("Pending", "Payment not confirmed yet", "info");
            } catch (e) {
                Swal.fire("Error", e.message || "Payment error", "error");
            } finally {
                document.getElementById("loading").style.display = "none";
            }
        });
    </script>

    <script>
        function openNav() {
            document.getElementById("mySidenav").style.width = "250px";
        }
        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
        }
        function logout() {
            sessionStorage.clear();
            window.location.href = "signin.html";
        }
    </script>

</body>

</html>